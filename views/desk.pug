<!DOCTYPE html>
html
	head
		title KOT Desk
		include ./meta.pug
		script.
			$(document).ready(function(){
				// fetch Menu
				$.get('/getMenu',
					{},
					function(data){
						if(data.error){
							alert(data.message);
						} else {
							$.each(data.message, function(index,value){
								if (value.is_default){
									$("#menu").append(new Option(value.name, value.name, true, true));
								} else {
									$("#menu").append(new Option(value.name, value.name));
								}
							});
							
							// Item Type
							$.get('/getItemType',
								{},
								function(data){
									if(data.error){
										alert(data.message);
									} else {
										$.each(data.message, function(index,value){
											$("#item_type").append(new Option(value.name, value.name));
										});
										
										// Item Category
										$.get('/getItemCategory',
											{},
											function(data){
												if(data.error){
													alert(data.message);
												} else {
													$.each(data.message, function(index,value){
														$("#item_category").append(new Option(value.name, value.name));
													});
													getFullMenu();
												}
											}
										);
									}
								}
							);
						}
					}
				);
				
				var getFullMenu = function(){
					// Get full menu
					$.post('/getFullMenu',
						{
							menu: $("#menu").val(),
							item_type: $("#item_type").val(),
							item_category: $("#item_category").val()
						},
						function(data){
							if(data.error){
								alert(data.message);
							} else {
								$("#demo").empty();
								$("#demo").append('<div class="row mainRow"></div>');

								var menuGroupId = [];
								var addHeader = function(id, value){
									$("#demo").find(".mainRow").append('<div class="col-sm-6" id="'+id+'"></div>');
									$("#demo").find("#"+id).append('<div class="panel panel-default"></div>');
									$("#demo").find("#"+id).find(".panel-default").append('<div class="panel-heading">'+value.menu_group+'</div>');
								}
								
								var addRow = function(id, value){
									var item = "";
									item += '<div class="panel-body" style="padding: 5px 5px 5px 15px; border-bottom: 1px solid #ddd;">';
									item += 	'<div class="row">';
									item += 		'<div class="col-xs-5">'+value.name+'</div>';
									item += 		'<div class="col-xs-3" style="padding:0;" data-rate="'+value.rate+'">'+'Nu. '+value.rate+'/-'+'</div>';
									item += 		'<div class="col-xs-4" style="padding: 0 0;">'+$("#qtyButtons").html()+'</div>';
									item += 	'</div>';
									item += '</div>';
									$("#demo").find("#"+id).find(".panel-default").append(item);
								}
								
								$.each(data.message, function(index,value){
									var id = value.menu_group.toLowerCase().replace(/ /g,"_");
																		
									if(menuGroupId.indexOf(id) < 0){
										menuGroupId.push(id);
										addHeader(id,value);
									}
									addRow(id,value);
								}); //Each row
							}
						}
					);
				}
				
				// All
				$('#menu').change(function(){
					getFullMenu();
				});
				
				$('#item_type').change(function(){
					getFullMenu();
				});
				
				$('#item_category').change(function(){
					getFullMenu();
				});
				
				$("#mySearch").on("keyup", function(){
					var value = $(this).val().toLowerCase();
					var menu_groups = [];
					$(".panel-default .panel-body").filter(function(){
						$(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
						if(menu_groups.indexOf($(this).parent().parent().get(0).id) < 0 && ($(this).text().toLowerCase().indexOf(value) > -1)){
							menu_groups.push($(this).parent().parent().get(0).id);
						}
					});
									
					$(".panel-default").parent().each(function(i, obj){
						$(this).toggle(menu_groups.indexOf($(this).get(0).id) > -1);
					});
				});
				
				$('body').on('click','.btn-number',function(){
					var row = $(this);
					var prevQty = parseInt(row.parent().find("#qty").val());
					var action = row.attr("data-type"); //plus or minus
					
					prevQty = (Number.isInteger(prevQty) ? prevQty : 0);
					if(action === "minus"){
						row.parent().find("#qty").val((prevQty <= 0) ? 0 : prevQty-1);
					} else {
						row.parent().find("#qty").val((prevQty < 0) ? 0 : prevQty+1);
					}
				});
			});
	body
		div(class="container-fluid")
			include ./navheader.pug
						
			div(class="container")
				div(class="form-group form-inline",style="margin-top: 60px;").
					<select id="menu" class="form-control"></select>		
					<select id="item_type" class="form-control">
						<option value="All" selected>All</option>
					</select>
					<select id="item_category" class="form-control">
						<option value="All" selected>All</option>
					</select>	
					<input class="form-control" id="mySearch" type="text" placeholder="Search...">

			div(class="container",id="demo") 
			
			div(id="qtyButtons",style="display:None;")
				div(class="form-group form-inline qtyButtons",style="margin:0;")
						button(type="button",class="btn btn-danger btn-number btn-xs",style="background:tomato;margin:0px;border-radius:3px 0px 0px 3px;",data-type="minus",data-field="quant[1]")
							span(class="glyphicon glyphicon-minus")
						input(id="qty",type="text",name="quant[1]",maxlength="2",class="form-control input-number",style="margin:0px; padding:6px 3px; display:inline-block; height: 22px; width: 40px;border-radius:0px;",value="0",min="0",max="100")
						button(type="button",class="btn btn-success btn-number btn-xs",style="margin:0px;border-radius:0px 3px 3px 0px;",data-type="plus",data-field="quant[1]")
							span(class="glyphicon glyphicon-plus")
											
			include ./navfooter.pug
